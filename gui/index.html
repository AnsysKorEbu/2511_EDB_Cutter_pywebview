<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDB 2D Viewer</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <div class="sidebar">
            <h2>EDB Cascade</h2>
            <div style="font-size: 11px; color: #858585; margin-top: -8px; margin-bottom: 12px;">Beta v0.6</div>

            <!-- Sidebar Tabs -->
            <div class="sidebar-tabs">
                <button class="tab-btn active" data-tab="data-info">Data Info</button>
                <button class="tab-btn" data-tab="layers">Layers</button>
                <button class="tab-btn" data-tab="nets">Nets</button>
                <button class="tab-btn" data-tab="cuts">Cuts</button>
            </div>

            <!-- Tab Content: Data Info -->
            <div class="tab-content active" id="data-info-tab">
                <div class="info-section">
                    <h3 style="font-size: 14px; margin-bottom: 10px; color: #9cdcfe;">Data Information</h3>
                    <div class="info-item">
                        <span class="info-label">Planes:</span>
                        <span class="info-value" id="planeCount">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Traces:</span>
                        <span class="info-value" id="traceCount">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Vias:</span>
                        <span class="info-value" id="viaCount">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Layers:</span>
                        <span class="info-value" id="layerCount">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Total Points:</span>
                        <span class="info-value" id="pointCount">0</span>
                    </div>
                </div>
                <button class="btn-reload" onclick="reloadData()" id="reloadBtn">Reload Data</button>
            </div>

            <!-- Tab Content: Layers -->
            <div class="tab-content" id="layers-tab">
                <div class="info-section">
                    <h3 style="font-size: 14px; margin-bottom: 10px; color: #9cdcfe;">Layers</h3>
                    <div class="layer-list" id="layerList">
                        <div style="color: #858585; font-size: 12px; text-align: center; padding: 20px;">
                            Click "Reload Data" to load
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Nets -->
            <div class="tab-content" id="nets-tab">
                <div id="nets-content">
                    <div style="color: #858585; font-size: 12px; text-align: center; padding: 20px;">
                        Loading nets...
                    </div>
                </div>
            </div>

            <!-- Tab Content: Cuts -->
            <div class="tab-content" id="cuts-tab">
                <button class="btn-cut-mode" onclick="toggleCutMode()" id="cutModeBtn">‚úÇÔ∏è Cut Mode</button>
                <button class="btn-execute-cut" onclick="openCutExecutor()" id="openExecuteCutBtn">Execute Cut</button>
                <button class="btn-analysis" onclick="openAnalysisGui()" id="openAnalysisBtn">üìä Analysis</button>
                <button class="btn-generate-run" onclick="openSchematicGui()" id="openSchematicBtn">‚ö° Generate & Run</button>

                <div id="cutTools" class="cut-tools hidden">
                    <h3 style="font-size: 14px; margin-bottom: 10px; color: #9cdcfe;">Cut Tools</h3>
                    <button class="cut-tool-btn" onclick="selectCutTool('line')" data-tool="line">
                        <span>üìè</span> Line Cut
                    </button>
                    <button class="cut-tool-btn" onclick="selectCutTool('rectangle')" data-tool="rectangle">
                        <span>‚ñ≠</span> Rectangle
                    </button>
                    <button class="cut-tool-btn" onclick="selectCutTool('polyline')" data-tool="polyline">
                        <span>üìê</span> Polyline
                    </button>
                    <button class="cut-tool-btn" onclick="selectCutTool('polygon')" data-tool="polygon">
                        <span>‚¨°</span> Polygon
                    </button>
                    <div
                        style="margin-top: 10px; padding: 8px; background: #252526; border-radius: 4px; font-size: 11px; color: #858585;">
                        <div id="cutHint">Select a tool to start</div>
                    </div>
                    <button id="finishCutBtn" class="hidden" onclick="finishCurrentCut()"
                        style="margin-top: 10px; background: #10a37f; width: 100%;">
                        ‚úì Finish & Save Cut
                    </button>
                    <button id="panModeBtn" onclick="togglePanMode()"
                        style="margin-top: 10px; background: #3e3e42; width: 100%;">
                        ü§ö Pan Mode (Space)
                    </button>
                </div>

                <div id="cutList" class="cut-list hidden">
                    <h3 style="font-size: 14px; margin-bottom: 10px; color: #9cdcfe;">Saved Cuts (<span
                            id="cutCount">0</span>)</h3>
                    <div id="cutListItems">
                        <div style="color: #858585; font-size: 11px; text-align: center;">No cuts saved</div>
                    </div>
                    <div class="cut-actions">
                        <button onclick="refreshCutList()">Refresh</button>
                        <button onclick="clearAllCuts()">Clear All</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-view">
            <div class="toolbar">
                <button onclick="resetView()">Reset View</button>
                <div class="zoom-controls">
                    <button class="icon-btn" onclick="zoomIn()">+</button>
                    <button class="icon-btn" onclick="zoomOut()">-</button>
                </div>
                <div class="controls">
                    <span class="control-label">Zoom:</span>
                    <span id="zoomLevel">100%</span>
                </div>
            </div>

            <div class="canvas-container">
                <canvas id="canvas"></canvas>
                <div class="loading hidden" id="loading">
                    <div class="spinner"></div>
                    <div>Loading data...</div>
                </div>
            </div>

            <div class="status-bar">
                <span id="statusText">Ready - Click "Reload Data" to load planes from source folder</span>
                <span id="mousePos">X: 0.000, Y: 0.000</span>
            </div>
        </div>
    </div>

    <!-- Cut Executor Modal -->
    <div id="cutExecutorModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Execute Cut</h2>
                <button class="modal-close" onclick="closeCutExecutor()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="executor-description">
                    Select a cut to execute on the EDB. This will open the EDB and apply the selected cut geometry.
                </div>
                <div id="executorCutList" class="executor-cut-list">
                    <div class="loading-state">
                        <p>Loading cuts...</p>
                    </div>
                </div>

                <!-- Stackup Processing Section -->
                <div class="executor-section-divider"></div>
                <div class="executor-stackup-section">
                    <h3>Stackup Processing</h3>
                    <div class="executor-description">
                        Process PCB stackup data from Excel file to extract layer materials and Dk/Df values.
                    </div>

                    <!-- Excel File & Section Selection -->
                    <div class="section-selection-area">
                        <div class="stackup-field-row">
                            <span class="stackup-field-label">Excel File</span>
                            <button class="btn-icon btn-icon-primary" onclick="useStackupExtractor()" title="Use FPCB-Extractor to process Excel files">
                                üîß Extractor
                            </button>
                            <button class="btn-icon btn-icon-secondary" onclick="editStackupWithEditor()" title="Edit stackup data with GUI editor">
                                ‚úèÔ∏è Edit
                            </button>
                            <button id="processSectionSelectionBtn" class="btn-icon" onclick="openSectionSelectionModal()" disabled title="Open section selection">
                                üìä Section Selection
                            </button>
                        </div>
                        <div id="excelFilePath" class="stackup-file-path">
                            No file selected
                        </div>
                    </div>

                    <!-- SSS File Path Display -->
                    <div class="sss-file-section">
                        <div class="stackup-field-row">
                            <span class="stackup-field-label">SSS File</span>
                            <button class="btn-icon" onclick="loadSssFile()" title="Load SSS File">
                                üìÇ Load
                            </button>
                            <button class="btn-icon btn-icon-danger" onclick="clearSssFileSelection()" title="Clear SSS File" id="clearSssBtn">
                                ‚úï
                            </button>
                        </div>
                        <div id="sssFilePath" class="stackup-file-path">
                            No file selected
                        </div>
                    </div>

                    <div id="stackupStatus" class="executor-status hidden"></div>
                </div>

                <!-- Execution Status (bottom of modal) -->
                <div id="executorStatus" class="executor-status hidden"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeCutExecutor()">Cancel</button>
                <button id="executeCutBtn" class="btn-primary" onclick="executeSelectedCut()" disabled>Execute</button>
            </div>
        </div>
    </div>

    <!-- Section Selection Modal -->
    <div id="sectionSelectionModal" class="modal hidden">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h2>Select Sections for Cuts</h2>
                <button class="modal-close" onclick="closeSectionSelection()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Excel File Selection -->
                <div class="section-excel-info">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span class="info-label">Excel File:</span>
                        <span style="font-size: 11px; color: #858585; font-style: italic;">
                            Use "Use stackup_extractor" button in Cut Executor
                        </span>
                    </div>
                    <div id="sectionExcelPath" class="info-value" style="color: #9cdcfe; font-size: 12px; word-break: break-all; min-height: 16px;">
                        No file selected
                    </div>
                </div>

                <!-- Available Sections Preview -->
                <div class="section-available">
                    <h3>Available Sections (<span id="sectionCount">0</span>)</h3>
                    <div id="sectionTags" class="section-tags"></div>
                </div>

                <!-- Cut-Section Mapping Grid -->
                <div class="section-mapping-container">
                    <h3>Select Section for Each Cut (1:1 mapping)</h3>
                    <div id="sectionMappingList" class="section-mapping-list">
                        <!-- Dynamically populated by JS -->
                    </div>
                </div>

                <!-- Status Messages -->
                <div id="sectionStatus" class="executor-status hidden"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeSectionSelection()">Cancel</button>
                <button id="saveSectionBtn" class="btn-primary" onclick="saveSectionSelection()">
                    Save Configuration
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Dialog Modal -->
    <div id="customDialog" class="modal hidden">
        <div class="modal-content custom-dialog-content">
            <div class="modal-header">
                <h2 id="dialogTitle">Dialog</h2>
                <button class="modal-close" onclick="closeCustomDialog()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="dialogMessage" class="dialog-message"></div>
                <input type="text" id="dialogInput" class="dialog-input hidden" />
            </div>
            <div class="modal-footer">
                <button id="dialogCancelBtn" class="btn-secondary hidden" onclick="closeCustomDialog()">Cancel</button>
                <button id="dialogConfirmBtn" class="btn-primary" onclick="confirmCustomDialog()">OK</button>
            </div>
        </div>
    </div>

    <!-- JavaScript modules -->
    <script src="canvas.js"></script>
    <script src="cutMode.js"></script>
    <script src="cutExecutor.js"></script>
    <script src="nets.js"></script>
    <script src="main.js"></script>
    <script src="customDialog.js"></script>
    <script src="sectionSelector.js"></script>
</body>

</html>